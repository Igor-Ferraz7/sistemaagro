<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extra√ß√£o e Lan√ßamento de NF</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos adicionais para a nova se√ß√£o de An√°lise do BD */
        .results-section {
            max-width: 1000px; /* Aumenta a largura para acomodar as novas colunas */
            margin: 30px auto 0;
            padding: 20px;
        }

        .data-group {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: left;
        }

        .data-group h3 {
            border-bottom: 2px solid #edf2f7;
            padding-bottom: 10px;
            margin-bottom: 15px;
            color: #2c5282;
            font-size: 1.25rem;
        }

        .db-analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Duas colunas para Fornecedor/Faturado */
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .db-item {
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background-color: #f7fafc;
        }

        .db-item .label {
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 5px;
            display: block;
        }

        .db-item .value {
            font-size: 1.1rem;
            word-break: break-all;
        }

        .status-nao-existe {
            color: #c53030; /* Vermelho (N√ÉO EXISTE) */
            font-weight: bold;
        }

        .status-existe {
            color: #38a169; /* Verde (EXISTE) */
            font-weight: bold;
        }

        .status-criado {
            color: #3182ce; /* Azul (CRIADO AGORA) */
            font-weight: bold;
        }

        .movimento-success {
            text-align: center;
            padding: 20px;
            background-color: #f0fff4; 
            border: 1px solid #9ae6b4; 
            border-radius: 6px;
            margin-top: 20px;
        }

        .movimento-success h4 {
            color: #38a169;
            font-size: 1.4rem;
            margin-bottom: 10px;
        }

        .movimento-fail {
            text-align: center;
            padding: 15px;
            background-color: #fff5f5; 
            border: 1px solid #feb2b2;
            border-radius: 6px;
            margin-top: 20px;
        }

        .movimento-fail h4 {
            color: #c53030;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Extra√ß√£o e Lan√ßamento de NF</h1>
            <p class="subtitle">Use a IA para extrair dados de notas fiscais em PDF, verificar no BD e lan√ßar o Contas a Pagar.</p>
        </div>

        <div class="upload-area">
            <input type="file" id="invoice-file" accept=".pdf" style="display: none;">
            <label for="invoice-file" class="custom-file-upload">
                <span>‚¨ÜÔ∏è</span> Selecionar PDF
            </label>
            <span id="file-name">Nenhum arquivo escolhido</span>
            <button id="extract-button" disabled><span>‚öôÔ∏è</span> EXTRAIR E LAN√áAR</button>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Processando... Analisando PDF e Banco de Dados...</p>
        </div>

        <div id="successMessage" class="message success-message">
             <strong>Sucesso!</strong> Dados extra√≠dos.
        </div>
        <div id="errorMessage" class="message error-message">
            <strong>Erro!</strong> <span id="errorText">Ocorreu um erro.</span>
        </div>

        <div id="resultsSection" class="results-section">
            <h2>‚úîÔ∏è Resultados da Extra√ß√£o e Lan√ßamento</h2>

            <div id="dbAnalysisSection" class="data-group">
                <h3>üìä An√°lise de Exist√™ncia e Lan√ßamento no BD</h3>
                <div id="dbAnalysisContent">Aguardando dados...</div>
            </div>

            <div class="data-group">
                <h3>üìÑ Dados Extra√≠dos (RAW JSON)</h3>
                <pre id="jsonOutput" class="json-output"></pre>
                <button id="copy-button">üìã Copiar JSON</button>
            </div>

            <p id="metadata" class="metadata"></p>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('invoice-file');
        const fileNameSpan = document.getElementById('file-name');
        const extractButton = document.getElementById('extract-button');
        const resultsSection = document.getElementById('resultsSection');
        const jsonOutput = document.getElementById('jsonOutput');
        const copyButton = document.getElementById('copy-button');
        const loading = document.getElementById('loading');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');

        // --- Fun√ß√µes de UI ---

        function showLoading() {
            loading.classList.add('show');
            extractButton.disabled = true;
            extractButton.style.background = '#a0aec0';
            extractButton.innerHTML = '<span>‚è≥</span> PROCESSANDO...';
        }

        function hideLoading() {
            loading.classList.remove('show');
            if (fileInput.files.length > 0) {
                extractButton.disabled = false;
            }
            extractButton.style.background = '#1a202c';
            extractButton.innerHTML = '<span>‚öôÔ∏è</span> EXTRAIR E LAN√áAR';
        }

        function showSuccess(message) {
            successMessage.innerHTML = message;
            successMessage.classList.add('show');
            setTimeout(() => successMessage.classList.remove('show'), 4000);
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.add('show');
            setTimeout(() => errorMessage.classList.remove('show'), 6000);
        }

        function hideMessages() {
            successMessage.classList.remove('show');
            errorMessage.classList.remove('show');
            resultsSection.classList.remove('show');
        }

        // --- L√≥gica de Display de Resultados ---

        function formatCurrency(value) {
            if (typeof value === 'string') {
                value = parseFloat(value);
            }
            if (isNaN(value) || value === null) {
                return 'R$ 0,00';
            }
            const reais = value / 100; 
            return reais.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function getStatusClass(status) {
            if (status === 'EXISTE') return 'status-existe';
            if (status === 'CRIADO') return 'status-criado';
            return 'status-nao-existe'; 
        }
        
        function getStatusText(status, id) {
             if (status === 'EXISTE') return `EXISTE ‚Äì ID: ${id}`;
             if (status === 'CRIADO') return `N√ÉO EXISTE (CRIADO) ‚Äì ID: ${id}`;
             return 'N√ÉO EXISTE (FALHA)';
        }

        function displayDbAnalysis(analysis, extractedData) {
            const contentDiv = document.getElementById('dbAnalysisContent');
            let html = '';
            let launchSuccess = false;

            // FORNECEDOR E FATURADO (GRID)
            html += '<div class="db-analysis-grid">';
            
            // FORNECEDOR
            const f = analysis.fornecedor;
            const fDocLabel = f.documento && f.documento.length > 11 ? 'CNPJ' : 'DOCUMENTO';
            
            html += `
                <div class="db-item">
                    <span class="label">FORNECEDOR:</span>
                    <div class="value">${f.razaoSocial || extractedData.fornecedor.razao_social || 'N/A'}</div>
                    <span class="label">${fDocLabel}:</span>
                    <div class="value">${f.documento || extractedData.fornecedor.cnpj || 'N/A'}</div>
                    <hr style="margin: 8px 0; border: 0; border-top: 1px solid #e2e8f0;">
                    <span class="label">Status no BD:</span>
                    <div class="value ${getStatusClass(f.status)}">${getStatusText(f.status, f.id)}</div>
                </div>
            `;

            // FATURADO
            const fa = analysis.faturado;
            const faDocLabel = fa.documento && fa.documento.length > 11 ? 'CNPJ' : 'CPF';
            
            html += `
                <div class="db-item">
                    <span class="label">FATURADO:</span>
                    <div class="value">${fa.razaoSocial || extractedData.faturado.nome_completo || 'N/A'}</div>
                    <span class="label">${faDocLabel}:</span>
                    <div class="value">${fa.documento || extractedData.faturado.cpf || 'N/A'}</div>
                    <hr style="margin: 8px 0; border: 0; border-top: 1px solid #e2e8f0;">
                    <span class="label">Status no BD:</span>
                    <div class="value ${getStatusClass(fa.status)}">${getStatusText(fa.status, fa.id)}</div>
                </div>
            `;
            html += '</div>'; 

            // N√öMERO DA NOTA FISCAL
            html += `
                <div class="db-item">
                    <span class="label">N√öMERO DA NOTA FISCAL:</span>
                    <div class="value">${extractedData.numero_nota_fiscal || 'N/A'}</div>
                </div>
            `;

            // CLASSIFICA√á√ÉO (DESPESA)
            const d = analysis.despesa;
            html += `
                <div class="db-item">
                    <span class="label">CLASSIFICA√á√ÉO (DESPESA):</span>
                    <div class="value">${extractedData.classificacao_despesa || 'N/A'}</div>
                    <span class="label">Status no BD:</span>
                    <div class="value ${getStatusClass(d.status)}">${getStatusText(d.status, d.id)}</div>
                </div>
            `;

            // MOVIMENTO (Sess√£o de Sucesso/Falha)
            const m = analysis.movimento;
            if (m && m.status === 'CRIADO_SUCESSO') {
                launchSuccess = true;
                html += `
                    <div class="movimento-success">
                        <h4>‚úÖ REGISTRO FOI LAN√áADO COM SUCESSO.</h4>
                        <p>Movimento ID: ${m.id} | Parcela ID: ${m.parcelaId} | Valor Total NF: ${formatCurrency(extractedData.valor_total)}</p>
                    </div>
                `;
            } else if (m) {
                html += `
                    <div class="movimento-fail">
                        <h4>‚ùå FALHA NO LAN√áAMENTO DO REGISTRO:</h4>
                        <p>${m.message}</p>
                    </div>
                `;
            }

            contentDiv.innerHTML = html;
            
            // Atualiza a mensagem principal no topo (5. INFORMAR AO USU√ÅRIO QUE REGISTRO FOI LAN√áADO COM SUCESSO)
            if (launchSuccess) {
                 showSuccess('<strong>Sucesso!</strong> Dados extra√≠dos e **Registro de Contas a Pagar Lan√ßado**!');
            } else {
                showSuccess('<strong>Aten√ß√£o!</strong> Dados extra√≠dos, mas houve um problema no lan√ßamento do Movimento. Verifique os IDs de depend√™ncia.');
            }
        }

        function displayResults(result) {
            hideLoading();
            hideMessages();
            
            if (result.dbAnalysis && result.data) {
                displayDbAnalysis(result.dbAnalysis, result.data);
            } else {
                 showError('Estrutura de resposta inv√°lida.');
            }

            jsonOutput.textContent = JSON.stringify(result.data, null, 2); 

            const metadata = document.getElementById('metadata');
            metadata.innerHTML = `
                <strong>Informa√ß√µes do Processamento:</strong><br>
                Arquivo: ${result.metadata.filename} |
                Tamanho: ${(result.metadata.fileSize / 1024).toFixed(1)} KB |
                Tempo: ${result.metadata.processingTime} |
                Processado em: ${new Date(result.metadata.timestamp).toLocaleString('pt-BR')}
            `;

            resultsSection.classList.add('show');
        }

        // --- Event Handlers ---

        fileInput.addEventListener('change', () => {
            hideMessages();
            if (fileInput.files.length > 0) {
                fileNameSpan.textContent = fileInput.files[0].name;
                extractButton.disabled = false;
            } else {
                fileNameSpan.textContent = 'Nenhum arquivo escolhido';
                extractButton.disabled = true;
            }
        });

        extractButton.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) {
                showError('Por favor, selecione um arquivo.');
                return;
            }

            const formData = new FormData();
            formData.append('invoice', file);

            hideMessages();
            showLoading();

            try {
                const response = await fetch('/extract-data', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    displayResults(data);
                } else {
                    showError(data.error || 'Erro desconhecido na extra√ß√£o.');
                    hideLoading();
                }

            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                showError('Erro ao se conectar com o servidor ou problema de rede.');
                hideLoading();
            }
        });

        copyButton.addEventListener('click', () => {
            navigator.clipboard.writeText(jsonOutput.textContent)
                .then(() => {
                    alert('JSON copiado para a √°rea de transfer√™ncia!');
                })
                .catch(err => {
                    console.error('Erro ao copiar:', err);
                    alert('Falha ao copiar o JSON.');
                });
        });


        // Test server connection on load
        fetch('/test')
            .then(response => response.json())
            .then(data => {
                if (!data.gemini_key_configured) {
                    showError('API do Gemini n√£o configurada. Configure a chave no arquivo .env do servidor.');
                }
            })
            .catch(() => {
                showError('Falha ao conectar com o servidor Node.js. Certifique-se de que est√° rodando.');
            });
    </script>
</body>
</html>